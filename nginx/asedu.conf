# ----------------------------------------------------
# å…¨å±€è®¾ç½®
# ---------------------------------------------------

# ----------------------------------------------------
# HTTP (80) ç«¯å£ï¼šå¼ºåˆ¶é‡å®šå‘åˆ° HTTPS
# ----------------------------------------------------
server {
    listen 80;
    server_name asedu.icu; # æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸå

    # æ°¸ä¹…é‡å®šå‘åˆ° HTTPS
    return 301 https://$host$request_uri;
}

# ----------------------------------------------------
# HTTPS (443) ç«¯å£ï¼šSSL ç»ˆæ­¢å’Œè½¬å‘æ ¸å¿ƒé…ç½®
# ----------------------------------------------------
server {
    listen 443 ssl http2;
    server_name asedu.icu; # æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸå
    
    # âš ï¸ SSL è¯ä¹¦è·¯å¾„ (å¤–éƒ¨ Nginx ä¸Šçš„å®é™…è·¯å¾„)
    ssl_certificate     /etc/nginx/ssl/asedu.icu.pem;
    ssl_certificate_key /etc/nginx/ssl/asedu.icu.key;

    # æ¨èçš„ SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;

    # å®¢æˆ·ç«¯æœ€å¤§ä¸»ä½“å¤§å°è®¾ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
    client_max_body_size 1000m;

    # é€šç”¨ä»£ç†å¤´éƒ¨è®¾ç½®
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # å‘ŠçŸ¥åç«¯çš„ Docker å®¹å™¨ï¼ŒåŸå§‹è¯·æ±‚æ˜¯ HTTPS
    proxy_set_header X-Forwarded-Proto https; 
    
    # ----------------------------------------------------
    # HTTP/HTTPS è½¬å‘å—
    # ----------------------------------------------------
    
    # é»˜è®¤è·¯å¾„ /app1/ -> å®¿ä¸»æœº 82 ç«¯å£
    location /app1/ {
        # è½¬å‘åˆ°å®¿ä¸»æœºçš„ 82 ç«¯å£
        proxy_pass http://127.0.0.1:82/;
    }
    location /app2/ {
        proxy_pass http://127.0.0.1:85/;
    }
    location /app3/ {
        # è½¬å‘åˆ°å®¿ä¸»æœºçš„ 82 ç«¯å£
        proxy_pass http://127.0.0.1:83/;
    }
    # API è·¯å¾„ /api/ -> å®¿ä¸»æœº 8090 ç«¯å£
    location /api/ {
        # è½¬å‘åˆ°å®¿ä¸»æœºçš„ 8090 ç«¯å£
        proxy_pass http://127.0.0.1:8090/;
        proxy_read_timeout 60s; # å¢åŠ  API è¯»å–è¶…æ—¶åˆ° 60 ç§’
    }

    # ğŸ“¢ æ–°å¢ï¼šå›¾ç‰‡è·¯å¾„ /img/ -> å®¿ä¸»æœº 9000 ç«¯å£
    location /img/ {
        # è½¬å‘åˆ°å®¿ä¸»æœºçš„ 9000 ç«¯å£
        proxy_pass http://127.0.0.1:9000/;
        # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº†å¸¦æ–œæ çš„ /ï¼Œè¯·æ±‚ `https://asedu.icu/img/test.jpg`
        # å°†è¢«è½¬å‘ä¸º `http://127.0.0.1:9000/test.jpg`
    }
    # ----------------------------------------------------
    # WSS -> WS è½¬å‘å— (WebSocket ä¸“å±)
    # ----------------------------------------------------
    location / {
        # è½¬å‘åˆ°å®¿ä¸»æœºçš„ 5200 ç«¯å£
        proxy_pass http://127.0.0.1:5200; 
        # **WebSocket å…³é”®è®¾ç½®**ï¼šå¿…é¡»å‡çº§è¿æ¥
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade; # å‘Šè¯‰ Nginx å‡çº§åè®®
        proxy_set_header Connection "upgrade";  # ä¿æŒè¿æ¥
        
        # å¢åŠ è¶…æ—¶ä»¥ä¿è¯é•¿è¿æ¥ä¸æ–­å¼€
        proxy_read_timeout 86400s; # 24 å°æ—¶
    }
}