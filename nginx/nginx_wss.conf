# 基础 GZIP 和 HTTP 配置
gzip on;
gzip_min_length 1k;
gzip_disable msie6;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 2;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;


# ----------------------------------------------------
# 1. HTTP Server 块 (重定向到 WSS 5210)
# ----------------------------------------------------
server {
    listen 80;
    server_name hy82s2hjk23.icu;
    return 301 https://$host:5210$request_uri;
}

# ----------------------------------------------------
# 2. WSS/HTTPS Server 块 (处理加密连接)
# ----------------------------------------------------
server {
    listen 5210 ssl http2;
    server_name hy82s2hjk23.icu;

    # 🌟 证书路径：必须是容器内的绝对路径 🌟
    # 根据您的卷映射 - ./nginx:/root/nginx，路径是 /root/nginx/certs/...
    ssl_certificate     /root/nginx/certs/hy82s2hjk23.icu_bundle.crt;
    ssl_certificate_key /root/nginx/certs/hy82s2hjk23.icu.key;

    # 基础 SSL 配置 (建议加上)
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # API 代理 (保持不变)
    location /api/ {
        proxy_pass http://tangsengdaodaoserver:8090/;
        client_max_body_size 1000m;
        client_body_buffer_size 500m;
    }

    # WSS/WebSocket 代理 (关键！)
    location /ws { # 假设您的 WSS 路径是 /ws
        # ------------------------------------------------
        # 必须的 WebSocket 升级头部
        # ------------------------------------------------
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    
        # ------------------------------------------------
        # 🌟 推荐的 IP 和协议识别头部 🌟
        # ------------------------------------------------
        proxy_set_header Host $host; 
    
        # 记录客户端真实 IP 地址
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
        # 记录原始协议和端口
        proxy_set_header X-Forwarded-Proto $scheme; # $scheme 在 WSS 场景下为 'https'
        proxy_set_header X-Forwarded-Port $server_port;
    
        # 转发到IM 服务
        proxy_pass http://wukongim:5210; 
    }

    # 静态文件服务
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
    }
}