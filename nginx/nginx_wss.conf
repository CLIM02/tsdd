# åŸºç¡€ GZIP å’Œ HTTP é…ç½®
gzip on;
gzip_min_length 1k;
gzip_disable msie6;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 2;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;


# ----------------------------------------------------
# 1. HTTP Server å— (é‡å®šå‘åˆ° WSS 5210)
# ----------------------------------------------------
server {
    listen 80;
    server_name hy82s2hjk23.icu;
    return 301 https://$host:5210$request_uri;
}

# ----------------------------------------------------
# 2. WSS/HTTPS Server å— (å¤„ç†åŠ å¯†è¿æ¥)
# ----------------------------------------------------
server {
    listen 5210 ssl http2;
    server_name hy82s2hjk23.icu;

    # ğŸŒŸ è¯ä¹¦è·¯å¾„ï¼šå¿…é¡»æ˜¯å®¹å™¨å†…çš„ç»å¯¹è·¯å¾„ ğŸŒŸ
    # æ ¹æ®æ‚¨çš„å·æ˜ å°„ - ./nginx:/root/nginxï¼Œè·¯å¾„æ˜¯ /root/nginx/certs/...
    ssl_certificate     /root/nginx/certs/hy82s2hjk23.icu_bundle.crt;
    ssl_certificate_key /root/nginx/certs/hy82s2hjk23.icu.key;

    # åŸºç¡€ SSL é…ç½® (å»ºè®®åŠ ä¸Š)
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # API ä»£ç† (ä¿æŒä¸å˜)
    location /api/ {
        proxy_pass http://tangsengdaodaoserver:8090/;
        client_max_body_size 1000m;
        client_body_buffer_size 500m;
    }

    # WSS/WebSocket ä»£ç† (å…³é”®ï¼)
    location /ws { # å‡è®¾æ‚¨çš„ WSS è·¯å¾„æ˜¯ /ws
        # ------------------------------------------------
        # å¿…é¡»çš„ WebSocket å‡çº§å¤´éƒ¨
        # ------------------------------------------------
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    
        # ------------------------------------------------
        # ğŸŒŸ æ¨èçš„ IP å’Œåè®®è¯†åˆ«å¤´éƒ¨ ğŸŒŸ
        # ------------------------------------------------
        proxy_set_header Host $host; 
    
        # è®°å½•å®¢æˆ·ç«¯çœŸå® IP åœ°å€
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
        # è®°å½•åŸå§‹åè®®å’Œç«¯å£
        proxy_set_header X-Forwarded-Proto $scheme; # $scheme åœ¨ WSS åœºæ™¯ä¸‹ä¸º 'https'
        proxy_set_header X-Forwarded-Port $server_port;
    
        # è½¬å‘åˆ°IM æœåŠ¡
        proxy_pass http://wukongim:5210; 
    }

    # é™æ€æ–‡ä»¶æœåŠ¡
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
    }
}